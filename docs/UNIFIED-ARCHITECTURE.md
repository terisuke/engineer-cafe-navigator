# 統一アーキテクチャ設計書

## 現状の問題点

1. **音声出力の分散**
   - 各エージェントが独自に音声出力を実装
   - エラーハンドリングが統一されていない
   - マークダウンやエモーションタグの処理が重複

2. **キャラクター制御の分散**
   - 表情制御がpage.tsx内に混在
   - リップシンクが独立して動作
   - エモーションとキャラクター表現の連携不足

3. **スライドシステムの独立性**
   - スライドナレーションが独自の音声処理
   - キャラクターとの連携が不十分

## 提案する統一アーキテクチャ

### レイヤー構造

```
┌─────────────────────────────────────────────────────────┐
│                    Frontend Layer                        │
│  (page.tsx, MarpViewer, CharacterAvatar)               │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────┐
│                 Orchestration Layer                      │
│              (RealtimeAgent, SlideNarrator)             │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────┐
│                  Business Logic Layer                    │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Q&A Agents                                      │   │
│  │ (BusinessInfoAgent, FacilityAgent, EventAgent,  │   │
│  │  GeneralKnowledgeAgent, MemoryAgent,           │   │
│  │  ClarificationAgent)                           │   │
│  └─────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────┐
│                  Presentation Layer                      │
│  ┌─────────────────┐  ┌──────────────────────────┐    │
│  │ VoiceOutputAgent│  │ CharacterControlAgent    │    │
│  │                 │  │                          │    │
│  │ - TTS生成       │  │ - 表情制御               │    │
│  │ - エラー処理    │  │ - リップシンク           │    │
│  │ - テキスト整形  │  │ - アニメーション         │    │
│  └─────────────────┘  └──────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

### データフロー

```
1. ユーザー入力
   ↓
2. RealtimeAgent/SlideNarrator（オーケストレーション）
   ↓
3. ビジネスロジックエージェント（応答生成）
   ↓
4. 統一レスポンス形式
   {
     text: string,           // プレーンテキスト
     emotion: string,        // エモーション
     metadata: {
       agentName: string,    // 応答したエージェント
       confidence: number,   // 信頼度
       language: string,     // 言語
     }
   }
   ↓
5. プレゼンテーション層で並列処理
   ├─→ VoiceOutputAgent（音声生成）
   └─→ CharacterControlAgent（キャラクター制御）
```

## 実装計画

### Phase 1: プレゼンテーション層の統一（優先度：高）

#### 1.1 VoiceOutputAgent の完全実装
- [x] 基本実装
- [ ] 全エージェントとの連携
- [ ] ストリーミング対応
- [ ] キャッシュ機能

#### 1.2 CharacterControlAgent の新規実装
```typescript
interface CharacterControlRequest {
  emotion: string;
  text?: string;  // リップシンク用
  audioData?: ArrayBuffer;  // リップシンク用
  duration?: number;  // アニメーション時間
}

interface CharacterControlResponse {
  success: boolean;
  expression?: string;
  animation?: string;
  lipSyncData?: LipSyncFrame[];
  error?: string;
}
```

### Phase 2: ビジネスロジック層の統一（優先度：高）

#### 2.1 統一レスポンス形式の実装
- 全エージェントが同じ形式で応答を返す
- エモーション情報を必ず含める
- メタデータの標準化

#### 2.2 エージェント間連携の改善
- RouterAgentの強化
- コンテキスト共有の改善

### Phase 3: スライドシステムの統合（優先度：中）

#### 3.1 SlideNarratorの改修
- VoiceOutputAgentの利用
- CharacterControlAgentとの連携
- ナレーションとキャラクターの同期

### Phase 4: エラーハンドリングの統一（優先度：中）

#### 4.1 エラー種別の定義
- ネットワークエラー
- API制限エラー
- 音声生成エラー
- キャラクター制御エラー

#### 4.2 フォールバック戦略
- 音声生成失敗時：テキスト表示
- キャラクター制御失敗時：デフォルト表情
- 完全失敗時：エラーメッセージ表示

## 期待される効果

1. **保守性の向上**
   - 音声処理の修正が1箇所で完結
   - キャラクター制御の修正が1箇所で完結
   - 新機能追加が容易

2. **拡張性の向上**
   - 新しいエージェントの追加が簡単
   - 新しい表現方法の追加が容易
   - 多言語対応の強化

3. **品質の向上**
   - 統一的なエラーハンドリング
   - 一貫したユーザー体験
   - パフォーマンスの最適化

## 移行計画

1. **段階的移行**
   - まずVoiceOutputAgentを完全に統合
   - 次にCharacterControlAgentを実装
   - 最後に既存コードのクリーンアップ

2. **後方互換性の維持**
   - 既存のAPIを維持しながら内部実装を変更
   - フォールバック機能の実装

3. **テスト戦略**
   - 各フェーズごとに統合テスト
   - パフォーマンステスト
   - エラーケースのテスト